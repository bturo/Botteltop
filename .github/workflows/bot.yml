name: Telegram Channel Bot

on:
  workflow_dispatch:  # Ø§Ø¬Ø±Ø§ÛŒ Ø¯Ø³ØªÛŒ
  schedule:
    - cron: '*/5 * * * *'  # Ù‡Ø± 5 Ø¯Ù‚ÛŒÙ‚Ù‡

jobs:
  run-bot:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install dependencies
      run: pip install telethon requests
      
    - name: Create bot script
      run: |
        cat > bot_runner.py << 'EOF'
import os
import re
import asyncio
import sys
from telethon import TelegramClient
from telethon.sessions import StringSession
import hashlib

# ØªÙ†Ø¸ÛŒÙ…Ø§Øª
API_ID = int(os.environ.get('API_ID', 31356424))
API_HASH = os.environ.get('API_HASH', '45ef11a0374c78dc7ced3d28f5cec9b5')
SOURCE_CHANNEL = os.environ.get('SOURCE_CHANNEL', 'https://t.me/filembad')
TARGET_CHANNEL = os.environ.get('TARGET_CHANNEL', '@TaKziBaM')
SESSION_STRING = os.environ.get('SESSION_STRING', '')

print("ðŸ¤– Ø´Ø±ÙˆØ¹ Ø±Ø¨Ø§Øª Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ù†Ø§Ù„...")
print(f"API_ID: {API_ID}")
print(f"SOURCE: {SOURCE_CHANNEL}")
print(f"TARGET: {TARGET_CHANNEL}")

# ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ
def replace_filembad(text):
    return text.replace('filembad', 'TaKziBaM')

def clean_config_text(text):
    text = text.strip()
    text = re.sub(r'[\n\r]+', '', text)
    text = re.sub(r'\s+', ' ', text)
    text = re.sub(r':\s*//', '://', text)
    return text

def get_config_hash(config_text):
    clean = config_text.lower().strip()
    clean = re.sub(r'\s+', '', clean)
    clean = re.sub(r'@takzibam', '', clean, flags=re.IGNORECASE)
    return hashlib.md5(clean.encode()).hexdigest()

async def main():
    if not SESSION_STRING:
        print("âŒ SESSION_STRING ÛŒØ§ÙØª Ù†Ø´Ø¯!")
        return
    
    # Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù„Ø§ÛŒÙ†Øª
    try:
        session = StringSession(SESSION_STRING)
        client = TelegramClient(session, API_ID, API_HASH)
        
        await client.connect()
        print("âœ… Ù…ØªØµÙ„ Ø´Ø¯ Ø¨Ù‡ ØªÙ„Ú¯Ø±Ø§Ù…")
        
        # Ø¨Ø±Ø±Ø³ÛŒ Ø§ØªØµØ§Ù„
        if not await client.is_user_authorized():
            print("âŒ session string Ù†Ø§Ù…Ø¹ØªØ¨Ø±!")
            return
        
        me = await client.get_me()
        print(f"ðŸ‘¤ Ú©Ø§Ø±Ø¨Ø±: {me.first_name}")
        
        # Ø¯Ø±ÛŒØ§ÙØª Ú©Ø§Ù†Ø§Ù„â€ŒÙ‡Ø§
        try:
            source_entity = await client.get_entity(SOURCE_CHANNEL)
            target_entity = await client.get_entity(TARGET_CHANNEL)
            print(f"ðŸ“¥ Ú©Ø§Ù†Ø§Ù„ Ù…Ù†Ø¨Ø¹: {source_entity.title}")
            print(f"ðŸ“¤ Ú©Ø§Ù†Ø§Ù„ Ù…Ù‚ØµØ¯: {target_entity.title}")
        except Exception as e:
            print(f"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ú©Ø§Ù†Ø§Ù„â€ŒÙ‡Ø§: {e}")
            return
        
        # Ø¯Ø±ÛŒØ§ÙØª Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§
        messages = await client.get_messages(source_entity, limit=20)
        print(f"ðŸ“¨ {len(messages)} Ù¾ÛŒØ§Ù… Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯")
        
        sent_hashes = set()
        configs_sent = 0
        proxies_sent = 0
        
        # Ø§Ù„Ú¯ÙˆÙ‡Ø§ÛŒ Ø¬Ø³ØªØ¬Ùˆ
        patterns = [
            (r'(vless://[^\s"\']+)', 'v2ray'),
            (r'(vmess://[^\s"\']+)', 'v2ray'),
            (r'(trojan://[^\s"\']+)', 'v2ray'),
            (r'(ss://[^\s"\']+)', 'v2ray'),
            (r'(https://t\.me/proxy[^\s"\']*)', 'proxy')
        ]
        
        # Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§
        for message in reversed(messages):
            if message.text:
                text = message.text
                
                for pattern, config_type in patterns:
                    matches = re.findall(pattern, text, re.IGNORECASE)
                    for match in matches:
                        clean_config = replace_filembad(match)
                        clean_config = clean_config_text(clean_config)
                        
                        if len(clean_config) < 10:
                            continue
                        
                        config_hash = get_config_hash(clean_config)
                        
                        if config_hash not in sent_hashes:
                            sent_hashes.add(config_hash)
                            
                            if config_type == 'v2ray':
                                caption = f"Ú©Ø§Ù†ÙÛŒÙ†Ú¯ Ø¬Ø¯ÛŒØ¯ v2ray\n\n{clean_config}\n\n@{TARGET_CHANNEL.replace('@', '')}"
                                configs_sent += 1
                            else:
                                caption = f"Ù¾Ø±ÙˆÚ©Ø³ÛŒ Ø¬Ø¯ÛŒØ¯ ØªÙ„Ú¯Ø±Ø§Ù…\n\n{clean_config}\n\n@{TARGET_CHANNEL.replace('@', '')}"
                                proxies_sent += 1
                            
                            try:
                                await client.send_message(
                                    target_entity,
                                    caption,
                                    link_preview=False
                                )
                                print(f"âœ… {config_type} Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯")
                                await asyncio.sleep(1)
                            except Exception as e:
                                print(f"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„: {e}")
        
        print(f"ðŸŽ¯ Ù†ØªÛŒØ¬Ù‡: {configs_sent} Ú©Ø§Ù†ÙÛŒÚ¯ Ùˆ {proxies_sent} Ù¾Ø±ÙˆÚ©Ø³ÛŒ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯")
        
        await client.disconnect()
        print("âœ… Ø§ØªØµØ§Ù„ Ù‚Ø·Ø¹ Ø´Ø¯")
        
    except Exception as e:
        print(f"ðŸ’¥ Ø®Ø·Ø§ÛŒ Ú©Ù„ÛŒ: {e}")
        import traceback
        traceback.print_exc()

if __name__ == '__main__':
    asyncio.run(main())
EOF
        
    - name: Run Bot
      env:
        API_ID: ${{ secrets.API_ID }}
        API_HASH: ${{ secrets.API_HASH }}
        SOURCE_CHANNEL: ${{ secrets.SOURCE_CHANNEL }}
        TARGET_CHANNEL: ${{ secrets.TARGET_CHANNEL }}
        SESSION_STRING: ${{ secrets.SESSION_STRING }}
      run: python bot_runner.py
